<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Online TV</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo="/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Players -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mpegts.js/1.7.3/mpegts.min.js"></script>
  <style>
    :root{--bg:#0e1116;--panel:#0f141b;--border:#1a2130;--text:#eaf0ff;--muted:#97a1b6;--primary:#0d8eff;--hair:rgba(255,255,255,.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:'Sarabun',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:14px auto 30px;padding:0 14px}
    .datetime{width:100%;text-align:center;margin:10px 0 6px}
    .chip{display:inline-block;padding:8px 14px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .dt-date{font-weight:700}
    .dt-time{font-weight:600;opacity:.95}
    .head{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--primary);box-shadow:0 0 10px rgba(13,142,255,.6)}
    .subtxt{color:#b9c3d8;font-size:.95rem}
    .player{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .topbar{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(--border)}
    .now{display:flex;align-items:center;gap:10px;min-width:0}
    .now img{width:30px;height:30px;border-radius:6px;object-fit:contain;background:#0003;padding:5px}
    .now .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .now .meta{color:var(--muted);font-size:.84rem}
    .vbox{position:relative;background:#000}
    video{width:100%;display:block;aspect-ratio:16/9;background:#000}
    .ctrl{position:absolute;left:0;right:0;bottom:0;display:flex;align-items:center;padding:8px 10px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.55));transform:translateY(8px);opacity:0;transition:.2s;z-index:2}
    .player:hover .ctrl,.ctrl.show{opacity:1;transform:translateY(0)}
    .ctrl-inner{display:flex;align-items:center;width:100%;gap:12px;justify-content:space-between}
    .side-left,.side-right{display:flex;align-items:center;gap:8px}
    .cbtn{width:34px;height:34px;display:grid;place-items:center;border-radius:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:#fff;cursor:pointer}
    .cbtn svg{width:18px;height:18px;pointer-events:none}
    #bar{flex:1;height:6px;accent-color:var(--primary);appearance:none;background:transparent}
    #bar::-webkit-slider-runnable-track{height:6px;background:rgba(255,255,255,.18);border-radius:999px}
    #bar::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;border-radius:50%;background:var(--primary);margin-top:-3px}
    .live{background:#e53935;color:#fff;font-weight:800;padding:4px 10px;border-radius:8px;font-size:.85rem}
    #vol{width:clamp(60px,12vw,100px);height:6px;appearance:none;background:transparent;accent-color:var(--primary)}
    #vol::-webkit-slider-runnable-track{height:6px;background:rgba(255,255,255,.18);border-radius:999px}
    #vol::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;border-radius:50%;background:var(--primary);margin-top:-2px}
    .t{min-width:140px;text-align:center;color:#d9e2ff;font-size:.85rem;opacity:.95}
    .hidden{display:none!important}
    .overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:rgba(6,10,18,.6);color:#fff;z-index:3;opacity:0;visibility:hidden;pointer-events:none;transition:.18s}
    .overlay.show{opacity:1;visibility:visible;pointer-events:auto}
    .spin{border:4px solid rgba(255,255,255,.35);border-top:4px solid var(--primary);width:42px;height:42px;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .unmute{position:absolute;left:50%;bottom:52px;transform:translateX(-50%);background:rgba(12,16,24,.8);border:1px solid rgba(255,255,255,.14);color:#fff;padding:6px 10px;border-radius:10px;font-size:.88rem;box-shadow:0 6px 22px rgba(0,0,0,.35);z-index:2}
    .unmute.hidden{display:none}
    .section{margin-top:16px}
    .section h3{margin:0 0 10px 2px;font-size:1rem;color:#dfe7ff;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
    .card{background:#101827;border-radius:10px;box-shadow:0 0 0 1px var(--hair) inset;padding:8px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:transform .15s,box-shadow .15s}
    .card:hover{transform:translateY(-1px);box-shadow:0 0 0 1px rgba(13,142,255,.45) inset}
    .logo-box{width:100%;aspect-ratio:1/1;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#0b1220}
    .logo-box img{max-width:88%;max-height:88%;object-fit:contain}
    .name{font-weight:700;font-size:.82rem;line-height:1.15;text-align:center;color:#eef3ff;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .card.active{box-shadow:0 0 0 2px var(--primary) inset,0 6px 20px rgba(13,142,255,.15)}
    @media(max-width:560px){.grid{gap:6px}.cbtn{width:32px;height:32px}.t{min-width:110px;font-size:.8rem}}
  </style>
</head>
<body>
  <!-- top date/time -->
  <div class="datetime">
    <div class="chip">
      <div id="dateTop" class="dt-date">—</div>
      <div id="timeTop" class="dt-time">—</div>
    </div>
  </div>

  <div class="wrap">
    <div class="head">
      <div class="brand"><div class="dot"></div><div>Online TV</div></div>
      <div class="subtxt" id="nowInfo" aria-live="polite">กำลังโหลดรายการช่อง…</div>
    </div>

    <!-- player -->
    <section class="player" id="playerSection" aria-busy="true">
      <div class="topbar">
        <div class="now">
          <img id="nowLogo" alt="">
          <div style="min-width:0">
            <div class="title" id="nowTitle">—</div>
            <div class="meta" id="nowMeta">—</div>
          </div>
        </div>
      </div>

      <div class="vbox" id="vbox">
        <video id="video" playsinline autoplay muted></video>

        <div class="overlay" id="overlay">
          <div class="spin"></div>
          <div id="ovtxt">กำลังโหลด…</div>
        </div>

        <div id="unmute-hint" class="unmute hidden">แตะเพื่อเปิดเสียง</div>

        <!-- controls -->
        <div class="ctrl" id="ctrl">
          <div class="ctrl-inner">
            <div class="side-left">
              <button id="play" class="cbtn" title="เล่น/หยุด (Space)">
                <svg class="i-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                <svg class="i-pause hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6zm8-14v14h4V5z"/></svg>
              </button>
              <span id="live" class="live hidden">LIVE</span>
            </div>

            <input id="bar" type="range" value="0" step="1" title="แถบเวลา">

            <div class="side-right">
              <button id="mute" class="cbtn" title="เปิด/ปิดเสียง (M)">
                <svg class="i-vol" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zM16.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                <svg class="i-mute hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-.22-.02-.43-.05-.63l-2.45-2.45V7.97A5.004 5.004 0 0121 12a7.9 7.9 0 01-.54 2.64l-1.51-1.51c.34-.82.54-1.7.54-2.64zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25 1.27-1.27L4.27 3z"/></svg>
              </button>
              <input id="vol" type="range" min="0" max="1" step="0.05" title="เสียง">
              <button id="fs" class="cbtn" title="เต็มจอ (F)">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zM5 10h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div id="sections"></div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ===== CONFIG ===== */
    // 1) ช่องของคุณ (ปรับเป็นของคุณเอง)
    const CHANNELS_URL = 'https://raw.githubusercontent.com/lancerza/tv-online/refs/heads/main/channels.json';

    // 2) Proxy สำหรับส่ง Referer/User-Agent จากฝั่งเซิร์ฟเวอร์ (ใส่ของคุณ)
    // ตัวอย่าง: 'https://your-domain.com/hls' หรือ 'https://your-worker.your-subdomain.workers.dev/hls'
    const PROXY_BASE = 'https://follow.don147ok.workers.dev';

    // 3) ค่าเริ่มต้น ถ้าช่องไม่ได้ใส่ referer/userAgent มากับ channels.json
    const DEFAULT_REF = 'https://99dooball.com/';
    const DEFAULT_UA = 'Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1';

    /* top time */
    const dateEl = document.getElementById('dateTop');
    const timeEl = document.getElementById('timeTop');
    function updateTop(){
      const now=new Date();
      dateEl.textContent = now.toLocaleDateString('th-TH',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
      timeEl.textContent = now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',hour12:false});
    }
    updateTop(); setInterval(updateTop,1000);

    /* state */
    let channels=null,hls=null,shakaP=null,tsPlayer=null,currentEngine='—',currentId=null,currentCat=null,token=0;
    const MAX_DUR=8*3600, LAST='tv_last_channel', VOL='tv_volume', FIRST='tv_first_visit_done';
    const sections=document.getElementById('sections');
    const playerSection=document.getElementById('playerSection');
    const video=document.getElementById('video');
    const overlay=document.getElementById('overlay'), ovtxt=document.getElementById('ovtxt');
    const ctrl=document.getElementById('ctrl'); let ctrlTimer;
    const play=document.getElementById('play'), iPlay=play.querySelector('.i-play'), iPause=play.querySelector('.i-pause');
    const mute=document.getElementById('mute'), iVol=mute.querySelector('.i-vol'), iMute=mute.querySelector('.i-mute');
    const bar=document.getElementById('bar'); const livePill=document.getElementById('live');
    const fs=document.getElementById('fs'); const vol=document.getElementById('vol');
    const nowInfo=document.getElementById('nowInfo'), nowTitle=document.getElementById('nowTitle');
    const nowMeta=document.getElementById('nowMeta'), nowLogo=document.getElementById('nowLogo');
    const unmuteHint=document.getElementById('unmute-hint');

    /* helpers */
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const isHls=(u)=>/\.m3u8(\?|$)/i.test(u);
    const isDash=(u)=>/\.mpd(\?|$)/i.test(u);
    const isTs=(u)=>/\.ts(\?|$)/i.test(u) || /\/ts\//i.test(u);
    const showOverlay=(t='กำลังโหลด…')=>{ovtxt.textContent=t;overlay.classList.add('show');};
    const hideOverlay=()=>overlay.classList.remove('show');
    const scrollToPlayer=()=>playerSection.scrollIntoView({behavior:'smooth',block:'start'});
    const cssEscape=(s)=>window.CSS&&CSS.escape?CSS.escape(s):String(s).replace(/([\\[\\].#:$'\"])/g,'\\$1');

    function isLiveLike(){const d=video.duration;return !isFinite(d)||d<=0||d>MAX_DUR}

    function syncVolUI(){
      vol.value=video.volume;
      const m=video.muted||video.volume===0;
      iVol.classList.toggle('hidden',m); iMute.classList.toggle('hidden',!m);
    }

    /* unload */
    async function unload(){
      if(hls){try{hls.destroy();}catch{} hls=null;}
      if(shakaP){try{await shakaP.destroy();}catch{} shakaP=null;}
      if(tsPlayer){try{tsPlayer.unload();tsPlayer.detachMediaElement();tsPlayer.destroy();}catch{} tsPlayer=null;}
      try{video.pause();}catch{}
      video.removeAttribute('src');
      try{video.load();}catch{};
      await sleep(60);
    }

    /* engine loaders */
    async function useHls(url){
      if(video.canPlayType('application/vnd.apple.mpegurl')){ video.src=url; currentEngine='HLS'; return; }
      if(window.Hls&&Hls.isSupported()){
        hls=new Hls({enableWorker:true,capLevelToPlayerSize:true,startLevel:-1,lowLatencyMode:false});
        hls.attachMedia(video); hls.on(Hls.Events.MEDIA_ATTACHED,()=>hls.loadSource(url));
        currentEngine='HLS'; return;
      }
      throw new Error('เบราว์เซอร์ไม่รองรับ HLS');
    }
    async function useShaka(chUrl, ch){
      shaka.polyfill.installAll(); if(!shaka.Player.isBrowserSupported()) throw new Error('เบราว์เซอร์ไม่รองรับ DASH');
      shakaP=new shaka.Player(video);
      const cfg={streaming:{bufferingGoal:25,rebufferingGoal:4},drm:{clearKeys:{}}};
      if(ch.license_key){const [kid,key]=String(ch.license_key).split(':'); if(kid&&key) cfg.drm.clearKeys[kid]=key;}
      shakaP.configure(cfg); await shakaP.load(chUrl); currentEngine='DASH';
    }
    async function useTs(url){
      if(!window.mpegts||!mpegts.isSupported()) throw new Error('เบราว์เซอร์ไม่รองรับ MPEG-TS');
      tsPlayer=mpegts.createPlayer({type:'mpegts',url,isLive:true},{enableWorker:true,liveBufferLatencyChasing:true});
      tsPlayer.attachMediaElement(video); await tsPlayer.load(); await video.play(); currentEngine='MPEG-TS';
    }

    /* time & progress */
    function refreshTimeUI(){
      const live=isLiveLike();
      livePill.classList.toggle('hidden',!live);
      bar.classList.toggle('hidden',live);
      if(!live){ bar.max=isFinite(video.duration)?video.duration:0; bar.value=video.currentTime||0; }
    }

    /* active card */
    function setActiveCard(cat,id){
      document.querySelectorAll('.card.active').forEach(el=>{el.classList.remove('active');el.setAttribute('aria-pressed','false');});
      const sel = `.card[data-cat="${cssEscape(cat)}"][data-id="${cssEscape(id)}"]`;
      const el=document.querySelector(sel);
      if(el){el.classList.add('active');el.setAttribute('aria-pressed','true');}
      localStorage.setItem(LAST,JSON.stringify({cat,id}));
    }

    /* autoplay hint */
    function showUnmute(){unmuteHint.classList.remove('hidden')}
    function hideUnmute(){unmuteHint.classList.add('hidden')}
    function restoreSavedVolume(){const v=parseFloat(localStorage.getItem(VOL)??'0.5'); video.volume=isFinite(v)?v:.5;}
    async function tryAutoplay(){try{video.muted=true;await video.play();showUnmute();}catch{}}
    ['click','touchstart','keydown'].forEach(e=>document.addEventListener(e,()=>{if(!unmuteHint.classList.contains('hidden')){restoreSavedVolume();video.muted=false;hideUnmute();}},{once:true,capture:true}));

    /* ===== NEW: proxy wrapper ===== */
    function proxify(url, ch){
      const needProxy = !!(ch.referer || ch.userAgent);
      if(!needProxy){ return url; }
      if(!PROXY_BASE){ return url; }
      const ref = encodeURIComponent(ch.referer || DEFAULT_REF);
      const ua  = encodeURIComponent(ch.userAgent || DEFAULT_UA);
      return `${PROXY_BASE}?url=${encodeURIComponent(url)}&ref=${ref}&ua=${ua}`;
    }

    function kindOf(src){
      if(isDash(src)) return 'dash';
      if(isTs(src)) return 'ts';
      if(isHls(src)) return 'hls';
      return 'unknown';
    }

    /* switch channel */
    async function switchChannel(cat,id){
      if(currentId===id && currentCat===cat){scrollToPlayer();return;}
      const tk=++token; const ch=channels[cat]?.[id]; if(!ch) return;
      currentId=id; currentCat=cat; showOverlay('กำลังโหลด…'); scrollToPlayer();

      try{
        await unload(); if(tk!==token) return;
        const srcKind = kindOf(ch.url);
        const playUrl = proxify(ch.url, ch); // play via proxy when needed

        if(srcKind==='ts')          await useTs(playUrl);
        else if(srcKind==='dash' || ch.license_key) await useShaka(playUrl, ch);
        else if(srcKind==='hls')    await useHls(playUrl);
        else throw new Error('ไม่รู้จักชนิดสตรีม');

        if(tk!==token) return;
        nowTitle.textContent=ch.name; nowLogo.src=ch.logo||'';
        const via = (ch.referer||ch.userAgent) ? 'ผ่าน Proxy (ส่ง Referer/User‑Agent)' : 'เชื่อมตรง';
        nowMeta.textContent = `${cat} · ${currentEngine} · ${via}`;
        nowInfo.textContent=ch.name; setActiveCard(cat,id);
        await tryAutoplay(); setTimeout(()=>overlay.classList.remove('show'),500);
      }catch(e){console.error(e); ovtxt.textContent='เล่นไม่ได้ ลองใหม่';}
    }

    /* build UI */
    function buildSections(){
      sections.innerHTML='';
      Object.keys(channels).forEach(cat=>{
        const sec=document.createElement('section'); sec.className='section';
        sec.innerHTML=`<h3>${cat}</h3><div class="grid"></div>`;
        const grid=sec.querySelector('.grid');
        Object.entries(channels[cat]).forEach(([id,ch])=>{
          const card=document.createElement('button');
          card.className='card'; card.dataset.cat=cat; card.dataset.id=id; card.title=ch.name;
          card.innerHTML=`<div class="logo-box"><img loading="lazy" src="${ch.logo||''}" alt=""></div><div class="name">${ch.name}</div>`;
          card.onclick=()=>switchChannel(cat,id);
          grid.appendChild(card);
        });
        sections.appendChild(sec);
      });
    }

    /* controls */
    document.getElementById('vbox').addEventListener('mousemove',()=>{clearTimeout(ctrlTimer);ctrl.classList.add('show');ctrlTimer=setTimeout(()=>ctrl.classList.remove('show'),1800);});
    document.getElementById('vbox').addEventListener('touchstart',()=>{clearTimeout(ctrlTimer);ctrl.classList.add('show');ctrlTimer=setTimeout(()=>ctrl.classList.remove('show'),1800);});

    play.addEventListener('click',()=>video.paused?video.play():video.pause());
    video.addEventListener('play',()=>{iPlay.classList.add('hidden');iPause.classList.remove('hidden');hideOverlay();});
    video.addEventListener('pause',()=>{iPlay.classList.remove('hidden');iPause.classList.add('hidden');});
    video.addEventListener('loadeddata',hideOverlay);
    video.addEventListener('canplay',hideOverlay);
    video.addEventListener('playing',hideOverlay);
    bar.addEventListener('input',e=>video.currentTime=+e.target.value);
    video.addEventListener('timeupdate',refreshTimeUI);
    video.addEventListener('loadedmetadata',refreshTimeUI);
    video.addEventListener('durationchange',refreshTimeUI);

    /* volume init */
    if(!localStorage.getItem(FIRST)){localStorage.setItem(FIRST,'1');localStorage.setItem(VOL,'0.5');}
    video.volume=parseFloat(localStorage.getItem(VOL)??'0.5'); syncVolUI();
    mute.addEventListener('click',()=>{ if(video.muted||video.volume===0){restoreSavedVolume();video.muted=false;hideUnmute();} else {video.muted=true;showUnmute();} syncVolUI(); localStorage.setItem(VOL,String(video.volume)); });
    vol.addEventListener('input',e=>{video.volume=+e.target.value;if(video.volume>0) video.muted=false; syncVolUI(); localStorage.setItem(VOL,String(video.volume));});
    video.addEventListener('volumechange',syncVolUI);

    fs.addEventListener('click',async()=>{try{const box=document.getElementById('vbox'); if(!document.fullscreenElement) await box.requestFullscreen(); else await document.exitFullscreen();}catch{}});

    document.addEventListener('keydown',(e)=>{const t=e.target.tagName; if(t==='INPUT'||t==='TEXTAREA') return;
      if(e.code==='Space'){e.preventDefault(); video.paused?video.play():video.pause();}
      else if(e.key.toLowerCase()==='m'){mute.click();}
      else if(e.key.toLowerCase()==='f'){fs.click();}
      else if(e.key==='ArrowRight'){video.currentTime=(video.currentTime||0)+5;}
      else if(e.key==='ArrowLeft'){video.currentTime=Math.max(0,(video.currentTime||0)-5);} 
    });

    /* load channels from GitHub */
    async function loadChannels(){
      const r=await fetch(CHANNELS_URL,{cache:'no-cache'});
      if(!r.ok) throw new Error('โหลด channels.json ไม่สำเร็จ');
      return r.json();
    }
    async function init(){
      try{
        channels=await loadChannels(); buildSections();
        let cat=Object.keys(channels)[0], id=Object.keys(channels[cat])[0];
        try{const saved=JSON.parse(localStorage.getItem(LAST)||'null'); if(saved&&channels[saved.cat]?.[saved.id]){cat=saved.cat;id=saved.id;}}catch{}
        nowInfo.textContent='เลือกช่องเพื่อเริ่มรับชม'; playerSection.removeAttribute('aria-busy');
        switchChannel(cat,id);
      }catch(err){console.error(err); nowInfo.textContent='โหลดรายการช่องไม่สำเร็จ'; showOverlay('โหลด "channels.json" ไม่ได้');}
    }
    init();
  });
  </script>
</body>
</html>
