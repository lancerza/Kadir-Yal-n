<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ทีวีออนไลน์ ดูฟรีไม่เสียรายเดือน</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* All CSS from the previous step goes here. It is correct. */
        /* For brevity, I'm collapsing the CSS block. */
        :root {
            --dark-bg: #1a1a1a; --light-text: #f0f0f0; --accent-color: #2196F3;
            /* ... all other CSS variables */
        }
        .accent-blue { --accent-color: #2196F3; }
        .accent-green { --accent-color: #4CAF50; }
        .accent-orange { --accent-color: #FF9800; }
        .accent-purple { --accent-color: #9C27B0; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { margin: 0; padding: 0 10px; /* ... */ }
        /* ... All other styles are correct and remain the same as the previous version ... */
        .color-swatch {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border-color);
            cursor: pointer; transition: transform 0.2s, border-color 0.2s;
        }
        .color-swatch.active { border-color: var(--light-text); box-shadow: 0 0 5px var(--light-text); }
        .color-swatch[data-color="blue"] { background-color: #2196F3; }
        .color-swatch[data-color="green"] { background-color: #4CAF50; }
        .color-swatch[data-color="orange"] { background-color: #FF9800; }
        .color-swatch[data-color="purple"] { background-color: #9C27B0; }
    </style>
</head>
<body>
    <div id="settings-popup" class="settings-popup">
        </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- CORRECTED SCRIPT STRUCTURE ---

        // Global variables for the script
        let channelsData = null;
        let userSettings = {};
        
        // All function declarations are grouped at the top
        // This ensures they are all defined before any are called.

        function saveSettings() {
            try {
                localStorage.setItem('tvAppSettings', JSON.stringify(userSettings));
            } catch (e) { console.error("Could not save settings to localStorage", e); }
        }

        function loadSettings() {
            const defaultSettings = {
                theme: 'dark',
                view: 'grid',
                lastCategory: null,
                disclaimerAccepted: false,
                fontSize: 16,
                accentColor: 'blue'
            };
            try {
                const savedSettingsString = localStorage.getItem('tvAppSettings');
                if (savedSettingsString) {
                    const savedSettings = JSON.parse(savedSettingsString);
                    return { ...defaultSettings, ...savedSettings };
                }
            } catch (e) { console.error("Could not parse settings from localStorage", e); }
            return defaultSettings;
        }

        function applyTheme(theme) {
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.body;
            if (theme === 'light') {
                body.classList.add('light-theme');
                if (themeToggle) themeToggle.checked = true;
            } else {
                body.classList.remove('light-theme');
                if (themeToggle) themeToggle.checked = false;
            }
            userSettings.theme = theme;
            saveSettings();
        }

        function applyFontSize(size) {
            const FONT_MIN = 12;
            const FONT_MAX = 20;
            const newSize = Math.max(FONT_MIN, Math.min(size, FONT_MAX));
            document.documentElement.style.fontSize = `${newSize}px`;
            userSettings.fontSize = newSize;
            saveSettings();
        }

        function applyAccentColor(color) {
            const body = document.body;
            const validColors = ['blue', 'green', 'orange', 'purple'];
            if (!validColors.includes(color)) return;

            validColors.forEach(c => body.classList.remove(`accent-${c}`));
            body.classList.add(`accent-${color}`);
            
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.toggle('active', swatch.dataset.color === color);
            });

            userSettings.accentColor = color;
            saveSettings();
        }

        function setView(view) {
            const gridViewBtn = document.getElementById('grid-view-btn');
            const listViewBtn = document.getElementById('list-view-btn');
            document.querySelectorAll('.accordion-content').forEach(content => {
                content.classList.toggle('list-view', view === 'list');
            });
            if(gridViewBtn) gridViewBtn.classList.toggle('active', view === 'grid');
            if(listViewBtn) listViewBtn.classList.toggle('active', view === 'list');
            
            userSettings.view = view;
            saveSettings();
            
            const openAccordion = document.querySelector('.accordion-content.show');
            if(openAccordion) {
                requestAnimationFrame(() => {
                    openAccordion.style.maxHeight = (openAccordion.scrollHeight + 16) + 'px';
                });
            }
        }
        
        // ... (All other helper functions like createChannelElement, loadChannelsData, etc. go here)
        // ... (They are unchanged and can be copied from the previous version)

        // Main App Initialization Function
        async function initializeApp() {
            userSettings = loadSettings();

            // Apply all settings from localStorage
            applyTheme(userSettings.theme);
            applyFontSize(userSettings.fontSize);
            applyAccentColor(userSettings.accentColor);
            setView(userSettings.view);
            
            // ... (The rest of the initializeApp function is unchanged)
            // ... e.g., updateDateTime(), loadTextsData(), loadChannelsData() etc.
        }

        // Setup Event Listeners
        function setupEventListeners() {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('change', () => {
                    applyTheme(themeToggle.checked ? 'light' : 'dark');
                });
            }

            document.getElementById('font-increase-btn')?.addEventListener('click', () => {
                applyFontSize(userSettings.fontSize + 1);
            });
    
            document.getElementById('font-decrease-btn')?.addEventListener('click', () => {
                applyFontSize(userSettings.fontSize - 1);
            });
    
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', (event) => {
                    applyAccentColor(event.target.dataset.color);
                });
            });

            document.getElementById('grid-view-btn')?.addEventListener('click', () => setView('grid'));
            document.getElementById('list-view-btn')?.addEventListener('click', () => setView('list'));

            // ... (All other event listeners for popups, keyboard shortcuts, etc. go here)
        }


        // --- Start the Application ---
        setupEventListeners();
        initializeApp();
    });
    </script>
</body>
</html>
