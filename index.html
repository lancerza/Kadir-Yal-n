<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Online TV</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Players -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.min.js"></script>

  <style>
    :root{--primary-color:#0d8eff;--background-color:#121212;--card-background:#1e1e1e;--text-color:#e0e0e0;--border-color:#333}
    *{box-sizing:border-box}
    body{margin:0;padding-bottom:24px;background:var(--background-color);color:var(--text-color);
      font-family:'Sarabun',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;display:flex;flex-direction:column;align-items:center}
    .container{width:95%;max-width:1000px}
    .header{text-align:center;padding:16px 0}
    #datetime-display{font-size:1.05em;background:var(--card-background);padding:8px 14px;border-radius:20px;display:inline-block;border:1px solid var(--border-color)}
    .video-container{position:relative;width:100%;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.5);background:#000}
    video{width:100%;display:block;aspect-ratio:16/9;background:#000}
    #channel-logo{position:absolute;top:10px;left:10px;z-index:4;width:52px;height:52px;border-radius:12px;object-fit:contain;background:rgba(0,0,0,.35);padding:6px;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(2px)}
    .custom-controls{position:absolute;left:0;right:0;bottom:0;z-index:3;padding:10px;display:flex;align-items:center;gap:14px;
      background:linear-gradient(to top,rgba(0,0,0,.85),transparent 70%);opacity:0;transform:translateY(100%);transition:opacity .25s,transform .25s}
    .video-container:hover .custom-controls,.custom-controls.visible{opacity:1;transform:translateY(0)}
    .control-btn{background:none;border:none;color:#fff;cursor:pointer;padding:6px;opacity:.85;transition:opacity .2s,transform .2s;border-radius:8px}
    .control-btn:hover{opacity:1;transform:translateY(-2px)}
    .control-btn svg{width:24px;height:24px;pointer-events:none}
    .hidden{display:none!important}
    #progress-bar,#volume-slider{accent-color:var(--primary-color)}
    #progress-bar{flex-grow:1}
    #volume-slider{width:110px}
    .go-live{border:1px solid rgba(255,255,255,.35);padding:4px 10px;border-radius:8px;font-weight:600;font-size:.9em;background:rgba(255,255,255,.07);color:#fff;cursor:pointer}
    #live-indicator{background:red;padding:4px 8px;border-radius:6px;font-weight:700;font-size:.8em}
    .overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.7);
      color:#fff;font-size:1.1em;text-align:center;padding:20px;pointer-events:none;opacity:0;transition:opacity .25s;z-index:5}
    .overlay.visible{opacity:1;pointer-events:auto}
    .spinner{border:4px solid rgba(255,255,255,.3);border-top:4px solid var(--primary-color);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-bottom:10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .category-header{width:100%;margin:26px 0 14px;padding-bottom:6px;font-size:1.4em;font-weight:700;color:var(--primary-color);border-bottom:2px solid var(--border-color);animation:fadeIn .5s ease forwards}
    .channel-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .channel-grid button{padding:12px;font-size:1em;border:1px solid var(--border-color);border-radius:10px;background:var(--card-background);color:var(--text-color);
      cursor:pointer;transition:all .18s;text-align:center;opacity:0;animation:fadeIn .5s ease forwards;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .channel-grid button:hover{border-color:var(--primary-color);transform:translateY(-3px);box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .channel-grid button.active{background:var(--primary-color);color:#fff;font-weight:700;border-color:var(--primary-color);box-shadow:0 0 16px rgba(13,142,255,.45)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
<div class="container">
  <div class="header"><div id="datetime-display">Loading time...</div></div>

  <div class="video-container" id="video-container">
    <img id="channel-logo" alt="logo" src="" />
    <video id="video" playsinline></video>

    <div id="video-overlay" class="overlay" aria-live="polite">
      <div id="overlay-content">
        <div id="spinner" class="spinner" style="display:none"></div>
        <span id="overlay-text"></span>
      </div>
    </div>

    <div class="custom-controls" id="custom-controls" role="group" aria-label="ตัวควบคุมวิดีโอ">
      <button id="play-pause-btn" class="control-btn" title="เล่น/หยุด (Space)">
        <svg viewBox="0 0 24 24" fill="currentColor" class="icon-play"><path d="M8 5v14l11-7z"></path></svg>
        <svg viewBox="0 0 24 24" fill="currentColor" class="icon-pause hidden"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
      </button>
      <input type="range" id="progress-bar" value="0" step="1" title="แถบเวลา">
      <span id="live-indicator" class="hidden">LIVE</span>
      <button id="go-live-btn" class="go-live hidden" title="ไปขอบสตรีม">Go Live</button>
      <button id="mute-btn" class="control-btn" title="เปิด/ปิดเสียง (M)">
        <svg viewBox="0 0 24 24" fill="currentColor" class="icon-volume-on"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
        <svg viewBox="0 0 24 24" fill="currentColor" class="icon-volume-off hidden"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>
      </button>
      <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1" title="ปรับเสียง">
      <button id="pip-btn" class="control-btn" title="Picture-in-Picture">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 7h-8v6h8V7zm2-4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"></path></svg>
      </button>
      <button id="fullscreen-btn" class="control-btn" title="เต็มจอ (F)">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg>
      </button>
    </div>
  </div>

  <div id="channels-container"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ---------- 1) Channels ----------
  const channels = {
    "กีฬา": {
      "aff_u23": {
        name: "Indo vs Thai U23",
        url: "https://tglmp04.akamaized.net/out/v1/400fc0702dee453bb33ebcc29466e58a/manifest.mpd",
        logo: "https://iili.io/FWccqEg.md.jpg",
        license_key: "91b9592c819246c68b3b08a1fe08ba22:fa0d80dfd865b34077bae44cd4a0c5e6"
      }
    },
    "ข่าว & ทั่วไป": {
      "thairath_dash": {
        name: "Thairath TV (DASH)",
        url: "https://tglmp02.akamaized.net/out/v1/cc0fc82e76cb4e0093e81695284af443/manifest.mpd",
        logo: "https://upload.wikimedia.org/wikipedia/th/b/b7/Thairath_TV_logo.png",
        license_key: "d418f733ed224f9bb9c2b1589db22a20:6ed6fe26daa4b926810869ff60254ebb"
      },
      "workpoint": {
        name: "Workpoint TV",
        url: "https://wp-live.cdn.3bb.co.th/wp/live/playlist.m3u8",
        logo: "https://upload.wikimedia.org/wikipedia/commons/4/49/Workpoint_TV_Logo.png",
        license_key: null
      },
      "thairathtv_hls": {
        name: "Thairath TV (HLS)",
        url: "https://d373k698imbfvs.cloudfront.net/out/v1/d08c879331984d948956b631988820c8/index.m3u8",
        logo: "https://upload.wikimedia.org/wikipedia/th/b/b7/Thairath_TV_logo.png",
        license_key: null
      }
    },
    "หนัง": {
      "hls_doomovic1": {
        name: "Smurfs(2025)สเมิร์ฟ",
        url: "https://master.streamhls.com/hlsr2/344daafccf7c29fc7134386f145c785e/master.m3u8",
        logo: "https://www.037hdd-movie.com/wp-content/uploads/2025/07/Smurfs-2025.jpg",
        license_key: null
      },
      "hls_doomovic2": {
        name: "AnHonestLife(2025)ชีวิตซื่อ",
        url: "https://master.streamhls.com/hlsr2/46cabdb7b096b7bfc651293e8a682fbd/master.m3u8",
        logo: "https://www.037hdd-movie.com/wp-content/uploads/2025/08/An-Honest-Life-2025.jpg",
        license_key: null
      },
      "hls_doomovic3": {
        name: " พระแท้ คนเก๊(2025)",
        url: "https://master.streamhls.com/hlsr2/7341740f96136f2ea13b204d01dc203d/master.m3u8",
        logo: "https://www.037hdd-movie.com/wp-content/uploads/2025/08/The-Stone-2025.jpg",
        license_key: null
      }
    },
    "ช่อง 3BB": {
      "3bb1": {
        name: "3BB 1",
        url: "https://udn-streamer1.cdn.3bbtv.com:8443/3bb/live/2/2.mpd",
        logo: "https://seeklogo.com/images/3/3bb-internet-logo-373928F5D7-seeklogo.com.png",
        license_key: "ca20a93cf8e3421dafbd5bdb1990081b:86ae86a7391c481ea93eecdb740f0a14"
      },
      "3bb2": {
        name: "3BB 2",
        url: "https://udn-streamer1.cdn.3bbtv.com:8443/3bb/live/3/3.mpd",
        logo: "https://seeklogo.com/images/3/3bb-internet-logo-373928F5D7-seeklogo.com.png",
        license_key: "4d4426a505f64382a9841155d721cee6:0f4770219ccb4be5836a7517057e51c3"
      },
      "3bb3": {
        name: "3BB 3",
        url: "https://udn-streamer1.cdn.3bbtv.com:8443/3bb/live/4/4.mpd",
        logo: "https://seeklogo.com/images/3/3bb-internet-logo-373928F5D7-seeklogo.com.png",
        license_key: "1e98456bcbea44b7ad05831387e364ef:3d14fd4f9d3149a79b35a7124fccbd67"
      }
    }
  };

  // ---------- 2) State & DOM ----------
  let shakaPlayer = null;
  let hls = null;
  let currentChannelId = null;
  let currentEngine = null; // 'shaka' | 'hls' | 'native'
  let controlsTimeout;
  let loadToken = 0; // ป้องกันการโหลดซ้อน

  const DOM = {
    video: document.getElementById('video'),
    videoContainer: document.getElementById('video-container'),
    channelLogo: document.getElementById('channel-logo'),
    channelsContainer: document.getElementById('channels-container'),
    overlay: document.getElementById('video-overlay'),
    overlayText: document.getElementById('overlay-text'),
    spinner: document.getElementById('spinner'),
    datetimeDisplay: document.getElementById('datetime-display'),
    customControls: document.getElementById('custom-controls'),
    playPauseBtn: document.getElementById('play-pause-btn'),
    progressBar: document.getElementById('progress-bar'),
    liveIndicator: document.getElementById('live-indicator'),
    goLiveBtn: document.getElementById('go-live-btn'),
    muteBtn: document.getElementById('mute-btn'),
    volumeSlider: document.getElementById('volume-slider'),
    pipBtn: document.getElementById('pip-btn'),
    fullscreenBtn: document.getElementById('fullscreen-btn'),
  };

  // ---------- 3) Utils ----------
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const isHlsUrl = (u) => /\.m3u8(\?|$)/i.test(u);
  const isDashUrl = (u) => /\.mpd(\?|$)/i.test(u);
  const showOverlay = (msg, spin=false) => {
    DOM.overlayText.textContent = msg || "";
    DOM.spinner.style.display = spin ? 'block' : 'none';
    DOM.overlay.classList.add('visible');
  };
  const hideOverlay = () => DOM.overlay.classList.remove('visible');

  function getChannelById(id){
    for(const cat in channels){ if(channels[cat][id]) return channels[cat][id]; }
    return null;
  }

  function isLive(){
    if(currentEngine==='shaka') return shakaPlayer ? shakaPlayer.isLive() : false;
    const v = DOM.video;
    return v.duration === Infinity || Number.isNaN(v.duration) || !isFinite(v.duration);
  }

  function goLive(){
    const v = DOM.video;
    const end = v.seekable?.length ? v.seekable.end(v.seekable.length-1) : null;
    if(end) v.currentTime = end - 0.5;
  }

  function saveVolume(vol, muted){ localStorage.setItem('otv_volume', JSON.stringify({vol, muted})); }
  function restoreVolume(){
    try{
      const s = JSON.parse(localStorage.getItem('otv_volume')||'null');
      if(!s) return; DOM.video.volume = Math.min(1, Math.max(0, s.vol||1)); DOM.video.muted = !!s.muted;
    }catch{}
  }

  // ---------- 4) Engine cleanup/reset ----------
  async function hardResetVideoElement(){
    // เคลียร์ให้ MediaSource ปิดสนิทก่อนเริ่มใหม่ (แก้ not open)
    const v = DOM.video;
    try{ v.pause(); }catch{}
    v.removeAttribute('src');
    try{ v.load(); }catch{}
    await sleep(120);
  }

  async function unloadEngines(){
    if(hls){ try{ hls.destroy(); }catch{} hls = null; }
    if(shakaPlayer){ try{ await shakaPlayer.destroy(); }catch{} shakaPlayer = null; }
    await hardResetVideoElement();
  }

  // ---------- 5) Load with retry ----------
  async function withRetry(taskFn, {retries=3, baseDelay=300} = {}){
    let attempt = 0, lastErr;
    while(attempt < retries){
      try{ return await taskFn(); }
      catch(err){
        lastErr = err;
        // หน่วงแบบ exponential backoff
        await sleep(baseDelay * Math.pow(2, attempt));
        attempt++;
      }
    }
    throw lastErr || new Error('Load failed');
  }

  // ---------- 6) Play engines ----------
  async function playWithShaka(channel){
    // สร้าง instance ใหม่ทุกครั้ง เพื่อลดโอกาส MediaSource ค้าง
    shaka.polyfill.installAll();
    if(!shaka.Player.isBrowserSupported()) throw new Error('เบราว์เซอร์ไม่รองรับ Shaka Player');

    shakaPlayer = new shaka.Player(DOM.video);
    shakaPlayer.addEventListener('error', (e)=>{
      console.error('Shaka error:', e.detail);
    });

    // ปรับ retry ภายในตัว player ให้ทนเน็ตแกว่ง
    shakaPlayer.configure({
      streaming: {
        bufferingGoal: 30, rebufferingGoal: 5,
        retryParameters: { timeout: 0, maxAttempts: 5, baseDelay: 500, backoffFactor: 2, fuzzFactor: 0.5 }
      },
      manifest: {
        retryParameters: { timeout: 0, maxAttempts: 5, baseDelay: 500, backoffFactor: 2, fuzzFactor: 0.5 }
      },
      drm: { clearKeys: {} }
    });

    if (channel.license_key){
      const [kid, key] = String(channel.license_key).split(':');
      if(kid && key) shakaPlayer.configure({ drm: { clearKeys: { [kid]: key } } });
    }

    await withRetry(async()=>{ 
      await shakaPlayer.load(channel.url);
      // รอให้ MediaSource เปิดจริง ๆ แล้วค่อยเล่น
      await sleep(120);
    }, {retries:3, baseDelay:300});

    currentEngine = 'shaka';
  }

  async function playWithHls(channel){
    const src = channel.url;
    const v = DOM.video;

    if (v.canPlayType('application/vnd.apple.mpegurl')) {
      v.src = src;
      await v.play().catch(()=>{});
      currentEngine = 'native';
    } else if (window.Hls && Hls.isSupported()){
      hls = new Hls({lowLatencyMode:true, backBufferLength:60, maxBufferLength:30, enableWorker:true});
      hls.attachMedia(v);
      hls.on(Hls.Events.MEDIA_ATTACHED, ()=> hls.loadSource(src));
      hls.on(Hls.Events.ERROR, (_, data)=>{
        console.warn('HLS error', data);
        if(data.fatal){
          if(data.type===Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
          else if(data.type===Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError();
          else try{ hls.destroy(); }catch{}
        }
      });
      currentEngine = 'hls';
    } else {
      throw new Error('เบราว์เซอร์ไม่รองรับ HLS');
    }
  }

  // ---------- 7) Switch channel (fix for MediaSource not open) ----------
  async function switchChannel(channelId){
    if (currentChannelId === channelId) return;

    const token = ++loadToken;       // กันซ้อน
    const channel = getChannelById(channelId);
    if(!channel){ showOverlay(`ไม่พบช่อง ${channelId}`, false); return; }

    currentChannelId = channelId;
    localStorage.setItem('lastWatchedChannel', channelId);
    updateActiveButton(channelId);
    DOM.channelLogo.src = channel.logo || '';
    showOverlay('กำลังโหลดช่อง...', true);

    try{
      // 1) ปิดทุก engine + reset video + หน่วงเล็กน้อย
      await unloadEngines();
      if (token !== loadToken) return;  // มีการสลับใหม่ทับ

      // 2) เลือกเอนจิน
      if (isDashUrl(channel.url) || channel.license_key) {
        await playWithShaka(channel);
      } else if (isHlsUrl(channel.url)) {
        await playWithHls(channel);
      } else {
        // fallback ลอง Shaka ก่อน
        await playWithShaka(channel);
      }

      if (token !== loadToken) return;
      hideOverlay();

      // 3) auto play
      if (DOM.video.paused) DOM.video.play().catch(()=>{});
    } catch(err){
      console.error(err);
      // ลองรีเซ็ตอีกรอบเผื่อ MediaSource ยังไม่ open
      if (token === loadToken){
        showOverlay('พยายามเชื่อมต่อใหม่...', true);
        try{
          await unloadEngines();
          await sleep(300);
          await (isDashUrl(channel.url) || channel.license_key ? playWithShaka(channel) : playWithHls(channel));
          hideOverlay();
          if (DOM.video.paused) DOM.video.play().catch(()=>{});
          return;
        }catch(e2){
          console.error('Retry failed:', e2);
          showOverlay(err?.message || 'เกิดข้อผิดพลาดในการโหลดช่อง', false);
        }
      }
    }
  }

  function updateActiveButton(id){
    document.querySelectorAll('.channel-grid button').forEach(b=>{
      b.classList.toggle('active', b.dataset.channelId===id);
      b.disabled = b.dataset.channelId===id;
    });
  }

  // ---------- 8) UI building ----------
  function generateChannelButtons(){
    DOM.channelsContainer.innerHTML = '';
    for(const categoryName in channels){
      const header = document.createElement('h2');
      header.className = 'category-header';
      header.textContent = categoryName;
      DOM.channelsContainer.appendChild(header);

      const grid = document.createElement('div');
      grid.className = 'channel-grid';
      let delay = 0;
      for(const id in channels[categoryName]){
        const ch = channels[categoryName][id];
        const btn = document.createElement('button');
        btn.innerText = ch.name;
        btn.dataset.channelId = id;
        btn.style.animationDelay = `${delay*0.05}s`;
        btn.onclick = () => switchChannel(id);
        grid.appendChild(btn);
        delay++;
      }
      DOM.channelsContainer.appendChild(grid);
    }
  }

  function startClock(){
    const update = ()=> {
      const now = new Date();
      const opts = {weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'};
      DOM.datetimeDisplay.textContent = now.toLocaleDateString('th-TH', opts);
    };
    update(); setInterval(update, 1000);
  }

  // ---------- 9) Controls / Events ----------
  function setupEventListeners(){
    const v = DOM.video;

    DOM.playPauseBtn.addEventListener('click', ()=> v.paused ? v.play() : v.pause());
    DOM.muteBtn.addEventListener('click', ()=> v.muted = !v.muted);

    DOM.fullscreenBtn.addEventListener('click', async ()=>{
      try{
        if(!document.fullscreenElement){
          await DOM.videoContainer.requestFullscreen();
          if(screen.orientation?.lock) screen.orientation.lock('landscape').catch(()=>{});
        }else await document.exitFullscreen();
      }catch{}
    });

    DOM.pipBtn.addEventListener('click', async ()=>{
      if('requestPictureInPicture' in v){ try{ await v.requestPictureInPicture(); }catch{} }
    });
    if(!('requestPictureInPicture' in v)){ DOM.pipBtn.disabled = true; DOM.pipBtn.title = 'อุปกรณ์นี้ไม่รองรับ PiP'; }

    DOM.volumeSlider.addEventListener('input', e => { v.volume = Number(e.target.value); if(v.volume>0 && v.muted) v.muted=false; saveVolume(v.volume, v.muted); });
    DOM.progressBar.addEventListener('input', e => { v.currentTime = Number(e.target.value); });
    DOM.goLiveBtn.addEventListener('click', goLive);

    v.addEventListener('play', ()=>{
      DOM.playPauseBtn.querySelector('.icon-play').classList.add('hidden');
      DOM.playPauseBtn.querySelector('.icon-pause').classList.remove('hidden');
    });
    v.addEventListener('pause', ()=>{
      DOM.playPauseBtn.querySelector('.icon-play').classList.remove('hidden');
      DOM.playPauseBtn.querySelector('.icon-pause').classList.add('hidden');
    });
    v.addEventListener('volumechange', ()=>{
      DOM.volumeSlider.value = v.volume;
      const muted = v.muted || v.volume===0;
      DOM.muteBtn.querySelector('.icon-volume-on').classList.toggle('hidden', muted);
      DOM.muteBtn.querySelector('.icon-volume-off').classList.toggle('hidden', !muted);
      saveVolume(v.volume, v.muted);
    });
    v.addEventListener('timeupdate', ()=>{
      if(isLive()){
        DOM.progressBar.classList.add('hidden');
        DOM.liveIndicator.classList.remove('hidden');
        DOM.goLiveBtn.classList.remove('hidden');
      }else{
        DOM.progressBar.classList.remove('hidden');
        DOM.liveIndicator.classList.add('hidden');
        DOM.goLiveBtn.classList.add('hidden');
        DOM.progressBar.max = isFinite(v.duration) ? v.duration : 0;
        DOM.progressBar.value = v.currentTime || 0;
      }
    });

    let controlsTimeout;
    const showControls = ()=>{
      clearTimeout(controlsTimeout);
      DOM.customControls.classList.add('visible');
      controlsTimeout = setTimeout(()=> DOM.customControls.classList.remove('visible'), 2500);
    };
    DOM.videoContainer.addEventListener('mousemove', showControls);
    DOM.videoContainer.addEventListener('touchstart', showControls);
    DOM.videoContainer.addEventListener('mouseleave', ()=>{ clearTimeout(controlsTimeout); DOM.customControls.classList.remove('visible'); });

    // Shortcuts
    document.addEventListener('keydown', (e)=>{
      const tag = document.activeElement?.tagName;
      if(tag==='INPUT' || tag==='TEXTAREA') return;
      if(e.code==='Space'){ e.preventDefault(); v.paused? v.play(): v.pause(); }
      else if(e.key.toLowerCase()==='m') v.muted = !v.muted;
      else if(e.key.toLowerCase()==='f') DOM.fullscreenBtn.click();
      else if(e.key==='ArrowRight') v.currentTime = (v.currentTime||0)+5;
      else if(e.key==='ArrowLeft') v.currentTime = Math.max(0,(v.currentTime||0)-5);
    });

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden && !isLive()) v.pause(); });
  }

  // ---------- 10) Init ----------
  async function init(){
    try{
      generateChannelButtons();
      startClock();
      setupEventListeners();
      restoreVolume();

      const urlParams = new URLSearchParams(location.search);
      const fromUrl = urlParams.get('ch');
      const last = localStorage.getItem('lastWatchedChannel');
      const firstId = Object.values(channels)[0] && Object.keys(Object.values(channels)[0])[0];
      const defaultId = fromUrl || last || firstId;
      if(defaultId) await switchChannel(defaultId);
    }catch(e){
      console.error(e);
      showOverlay('เกิดข้อผิดพลาดในการเริ่มต้น', false);
    }
  }

  init();
});
</script>
</body>
</html>
